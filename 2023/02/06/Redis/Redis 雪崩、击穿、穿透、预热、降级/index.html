<!DOCTYPE html><html lang="zh_CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>Redis 雪崩、击穿、穿透、预热、降级 | 每天进步一点点</title><meta name="author" content="issac"><meta name="copyright" content="issac"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="1、缓存击穿缓存击穿根据名字根本无法看懂是什么意思，并且很容易和另一个词——缓存穿透搞混。缓存击穿指的是某个 key 一直在扛着高并发!!!，所谓扛着高并发就是说大量的请求都是获取这个 key 对应的值。 而这个 key 在某个时间突然失效了，那是不是就意味着大量的请求就无法在缓存中获取数据了，而是"><link rel="shortcut icon" href="/img/kid.png"><link rel="canonical" href="https://issac2e.github.io/2023/02/06/Redis/Redis%20%E9%9B%AA%E5%B4%A9%E3%80%81%E5%87%BB%E7%A9%BF%E3%80%81%E7%A9%BF%E9%80%8F%E3%80%81%E9%A2%84%E7%83%AD%E3%80%81%E9%99%8D%E7%BA%A7/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Redis 雪崩、击穿、穿透、预热、降级',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-02-08 06:02:52'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = url => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      link.onload = () => resolve()
      link.onerror = () => reject()
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/./img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">15</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">14</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">8</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/./img/preview5.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="每天进步一点点"><span class="site-name">每天进步一点点</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Redis 雪崩、击穿、穿透、预热、降级</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-02-06T22:36:08.000Z" title="Created 2023-02-06 22:36:08">2023-02-06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-02-08T06:02:52.459Z" title="Updated 2023-02-08 06:02:52">2023-02-08</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Redis/">Redis</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Redis 雪崩、击穿、穿透、预热、降级"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="1、缓存击穿"><a href="#1、缓存击穿" class="headerlink" title="1、缓存击穿"></a>1、缓存击穿</h1><p>缓存击穿根据名字根本无法看懂是什么意思，并且很容易和另一个词——缓存穿透搞混。缓存击穿指的是<font color="#dd0000"><strong>某个 key 一直在扛着高并发!!!</strong></font>，所谓扛着高并发就是说大量的请求都是获取这个 key 对应的值。</p>
<p>而这个 key 在某个时间突然失效了，那是不是就意味着大量的请求就无法在缓存中获取数据了，而是去请求数据库了，这样很有可能导致数据库被击垮。这就是缓存击穿。</p>
<p>那现在问题知道了，该如何应对呢？这个就比较简单了，既然这个 key 这个受欢迎，那么就不要设置过期时间了，如果该key的数据更新了，那么就通过互斥锁的方式将其更新。</p>
<p>为什么要用互斥锁的方式？如果不使用互斥锁的方式很容易导致数据不一致的情况，这里为了保证缓存和数据库的一致性，就只能牺牲一点点的效率了。</p>
<p>如果发现缓存没有数据，使用互斥独占锁防止击穿 ！（多个线程同时去查询这条数据，在第一个查询的请求上使用一个互斥锁来锁住它，其它线程只有等到第一个线程查询到数据，然后缓存。后面的线程进来后发现已经有缓存 了，就直接走缓存）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> User <span class="title function_">findUserById</span><span class="params">(Integer id)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;user:&quot;</span>+id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1 先从redis里面查询，如果有直接返回结果，如果没有再去查询mysql</span></span><br><span class="line">    user = (User) redisTemplate.opsForValue().get(key);</span><br><span class="line">    <span class="keyword">if</span>(user != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">　　<span class="comment">//双重检测机制！！</span></span><br><span class="line">    <span class="keyword">if</span>(user == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//2 对于高QPS的优化，进来就先加锁，保证一个请求操作，让外面的redis等待一下，避免击穿mysql</span></span><br><span class="line">        <span class="keyword">synchronized</span> (UserService.class)&#123;</span><br><span class="line">        <span class="comment">//这里让之前在外面等待的线程随后进来后可以直接走缓存，前提是前面有线程回写。</span></span><br><span class="line">            user = (User) redisTemplate.opsForValue().get(key);</span><br><span class="line">            <span class="comment">//3 二次查redis还是null，可以去查mysql了(mysql默认有数据),</span></span><br><span class="line">            <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">//4 查询mysql拿数据</span></span><br><span class="line">                user = userMapper.selectByPrimaryKey(id);<span class="comment">//mysql有数据默认</span></span><br><span class="line">               <span class="comment">//5 mysql里面有数据的，需要回写redis，完成数据一致性的同步工作</span></span><br><span class="line">                redisTemplate.opsForValue().setIfAbsent(key,user,<span class="number">7L</span>,TimeUnit.DAYS);</span><br><span class="line">                <span class="keyword">return</span> user;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关于双重检测机制：</p>
<p>双重检测机制可以解决Redis缓存热点key失效（缓存击穿）的问题，但是可能存在线程安全的问题。在使用双重检测机制时，针对于被检测的对象，如果是全局变量，则要考虑该变量后续操作的原子性。最好是通过volatile关键字进行修饰，当然如果是基本类型如int,bool,long，则可以用Actomicxxx来进行定义如ActomicLong。当然最笨重的方法是对整体的方法加synchronized。</p>
<h1 id="2、缓存雪崩"><a href="#2、缓存雪崩" class="headerlink" title="2、缓存雪崩"></a>2、缓存雪崩</h1><p>发生场景：1 redis主机挂了，Redis全盘崩溃。 2 比如缓存中有大量数据同时过期。3 内存达到阙值，内存淘汰机制删除了一些数据。</p>
<p>解决办法：</p>
<ul>
<li><p> redis缓存集群实现高可用 主从+ 哨兵。 redis cluster </p>
</li>
<li><p>emcache 本地缓存 + Hystrix 或者阿里sentinel限流 + 降级</p>
</li>
<li><p>开启redis持久化机制aof&#x2F;rdb, 尽快恢复缓存集群。</p>
</li>
<li><p> 提前规划好缓存的到期时间</p>
</li>
</ul>
<p>Redis雪崩我们一般都称为缓存雪崩，意思就是说在某个时间节点，大量的 key 失效，导致大量的请求从缓存中获取不到数据而去请求数据库。根据上面的那张图，我们再来画下雪崩的情况的是什么样子的：</p>
<p><img src="/images/WEBRESOURCE60dde9c7ebe4768e7e2c84bdc723a073.png"></p>
<p>上面的黑色的部分表示缓存无效了，也就意味着所有的请求都需要到数据库中去查询数据。那这对于数据库的压力必然是剧增的，如果是在一线互联网这样超高并发的场景下，数据库直接宕机。</p>
<p>重启也没有用，因为重启了还会有巨大的流量涌进来，然后继续被搞宕机。所以对于预防缓存雪崩这种情况的发生意义还是很大的的。</p>
<ol>
<li>缓存雪崩解决方案之加随机值</li>
</ol>
<p>上面已经详细介绍了什么是缓存雪崩，他是怎么发生的，那如果防止缓存雪崩呢？</p>
<p>很简单，因为上面刚刚说到，缓存雪崩是由于某个时间节点大量的 key 失效而导致的问题，那现在的问题不就是变成了如何防止同一个时间节点大量的 key 失效这种情况发生吗？</p>
<p>最简单的情况就是把key的过期时间分散开，也就是在设置key的过期时间的时候再加一个随机值，就这样就能完美的解决缓存雪崩的问题。</p>
<p>但是你以为我说到这里就完事了？既然是一次全安排，那么我一定不会仅仅告诉你一种解决方案就完事的。继续看</p>
<ol>
<li>缓存雪崩解决方案之加锁</li>
</ol>
<p>可能很多人看到这个方案表示不接受，加锁那不是限制了并发？加锁必然导致阻塞。如果是加锁，那么执行就成就是这个样子了：</p>
<p><img src="/images/WEBRESOURCEdeb69e37e6898fc81981b6132202cdce.png"></p>
<p>流程是这样子的，在多个请求同时到达业务系统时候，只能有一个线程能获取到锁，然后才能继续去缓存或者是数据库中查询数据，然后后面的流程和之前的是一样的，执行完成后释放锁，然后其他线程再争抢锁，然后重复前面的流程。</p>
<p>这个方案的优点是可以很好的保护数据库不会被打挂，缺点就是并发度极低。</p>
<p>上面这个方案其实还是可以再优化下的：</p>
<p><img src="/images/WEBRESOURCE73d67bb00d23f4bb489fd2897f433960.png"></p>
<p>这个就是在缓存中如果获取不到，再去串行的访问数据看，这里不一定非要串行，可以配合线程池，控制一定的并发数。</p>
<p>这个缺点虽然很多，但是也是一种解决方案。用不用就看实际的业务场景了。毕竟没有没用技术方案，只有不适合业务场景的技术方案（手动狗头）。</p>
<h1 id="3、缓存穿透"><a href="#3、缓存穿透" class="headerlink" title="3、缓存穿透"></a>3、缓存穿透</h1><p>缓存穿透意思就是某个不存在的key一直被访问，结果发现数据库中也没有这样的数据，最终导致访问该key的所有请求都直接请求到数据库了。如果是并发高的场景下就容易搞垮数据库。大家有没有发现我们做的一些事情都是在保护“弱小的数据库”。</p>
<p>那现在问题已经知道了，我们该如何去解决这个问题呢？1、IP过滤； 2、参数校验； 3、布隆过滤器；</p>
<h2 id="1、缓存穿透解决方案之缓存空数据"><a href="#1、缓存穿透解决方案之缓存空数据" class="headerlink" title="1、缓存穿透解决方案之缓存空数据"></a>1、缓存穿透解决方案之缓存空数据</h2><p>啥叫缓存空数据？就是假设某个key数据并不存在，那么就存一个 NULL 就好了，但是一定不要忘记设置过期时间，因为假设id&#x3D;3的记录不存在，然后本次访问没有查询到数据，缓存中存的是null如果过一会儿新增了一条记录为3的数据，如果缓存不设置过期时间，那么这条数据就永远获取不到。</p>
<h2 id="2、缓存穿透解决方案之布隆过滤器"><a href="#2、缓存穿透解决方案之布隆过滤器" class="headerlink" title="2、缓存穿透解决方案之布隆过滤器"></a>2、缓存穿透解决方案之布隆过滤器</h2><p>布隆过滤器？这玩意到底什么意思？</p>
<p>布隆过滤器是一种数据结构，更准确的说是一种概率型的数据结构，因为它能判断某个元素一定不存在或者是可能存在。</p>
<p>就这句话，搞蒙了很多人，今天我非要把你说明白了。布隆过滤器是一个bit数组，一个很长的bit数组和一系列的hash函数构成。先看下图</p>
<p><img src="/images/WEBRESOURCE3e8aa8e049b2105acc41f5e79ab0f186.png"></p>
<hr>
<h3 id="布隆过滤器说明白！"><a href="#布隆过滤器说明白！" class="headerlink" title="布隆过滤器说明白！"></a>布隆过滤器说明白！</h3><h4 id="1、两个使用场景"><a href="#1、两个使用场景" class="headerlink" title="1、两个使用场景:"></a>1、两个使用场景:</h4><ol>
<li><p>网页爬虫对URL的去重，避免爬取相同的URL地址（黑名单）</p>
</li>
<li><p>缓存穿透，将所有可能存在的数据缓存放到布隆过滤器中，当黑客访问不存在的缓存时迅速返回避免缓存及DB挂掉。（白名单）</p>
</li>
</ol>
<p>布隆过滤器做白名单使用：白名单里有的才让通过，没有直接返回，但是存在误判由于误判率很小，mysql可以接受。</p>
<p>使用时需注: 所有key需要往redis和布隆过滤器里面放入。!</p>
<p><img src="/images/WEBRESOURCE8856183799b2e36ba80c416cbd0e9847.png"></p>
<p>布隆过滤器做黑名单使用：</p>
<p><img src="/images/WEBRESOURCEb961af14d547ac2c3cb6cb6139b02eaa.png"></p>
<h4 id="2、原理"><a href="#2、原理" class="headerlink" title="2、原理"></a>2、原理</h4><p>其内部维护一个全为0的bit数组，需要说明的是，布隆过滤器有一个误判率的概念，误判率越低，则数组越长，所占空间越大。误判率越高则数组越小，所占的空间越小。</p>
<p>我们现在来举个例子，假设现在有小强和旺财两个人，他们分别经过三次hash得到的下标是这样子的（布隆过滤器不存储元素，仅仅是为一个元素是否存在打一个标志）</p>
<p>小强经过上面的三个hash后得到的下标分别为：2、4、5，那么该数组的2、4、5位置就会被置为1，也就是此时是这样子的</p>
<p><img src="/images/WEBRESOURCE94374bdeee01100a09c5c6a0e54606e9.png"></p>
<p>同样旺财经过上面的三个hash后得到的下标分别为：3、7、11，那么该数组的3、7、11位置就会被置为1，也就是此时是这样子的</p>
<p><img src="/images/WEBRESOURCE0be4e118c4022017e8a88808ca41e818.png"></p>
<p>现在假设来一个 007 经过上面的三个hash后得到的下标分别为：11、13、15因为13、和15位置是0，所以一定可以判断007 一定不存在。但是现在又来了一个</p>
<p>9527经过上面的三个hash后得到的下标分别为：2、5、7，但是你会发现257三个位置全部是1，那这个到底说明9527是存在还是不存在呢？</p>
<p>从我们上面的讲解可以 9527 之前并不存在，但是由于hash冲突，但是9527的三个下标值也刚好落在已经被置为1的下标位置，这就导致此时是无法判断9527是否存在的（可能存在）。这就是布隆过滤器的原理。</p>
<h4 id="3、如何减少误判的发生："><a href="#3、如何减少误判的发生：" class="headerlink" title="3、如何减少误判的发生："></a>3、如何减少误判的发生：</h4><ol>
<li><p>增加二进制数组位数：如100位数组索引，扩大到10000位</p>
</li>
<li><p>增加Hash次数：如3次hash扩大到5次hash</p>
</li>
</ol>
<p>减少误判的代价就是CPU需要更多的运算，会让布隆过滤器的性能降低。</p>
<h4 id="4、实现"><a href="#4、实现" class="headerlink" title="4、实现"></a>4、实现</h4><p>我们来使用 google 包下的类来测试。首先要添加依赖；java中提供了一个redisson的组件，这个组件内置了布隆过滤器并存储在redis服务器中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.google.guava&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;guava&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">30.1</span>-jre&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.redisson&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;redisson-all&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">3.16</span><span class="number">.0</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BloomFilterDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 创建一个插入对象为一亿，误报率为0.01%的布隆过滤器</span></span><br><span class="line"><span class="comment">         * 不存在一定不存在</span></span><br><span class="line"><span class="comment">         * 存在不一定存在</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        BloomFilter&lt;CharSequence&gt; bloomFilter = BloomFilter.create(Funnels.stringFunnel(Charset.forName(<span class="string">&quot;utf-8&quot;</span>)),</span><br><span class="line">                <span class="number">100000000</span>,</span><br><span class="line">                <span class="number">0.0001</span>);</span><br><span class="line">        bloomFilter.put(<span class="string">&quot;死&quot;</span>);</span><br><span class="line">        bloomFilter.put(<span class="string">&quot;磕&quot;</span>);</span><br><span class="line">        bloomFilter.put(<span class="string">&quot;Redis&quot;</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(bloomFilter.mightContain(<span class="string">&quot;Redis&quot;</span>));</span><br><span class="line">        System.out.println(bloomFilter.mightContain(<span class="string">&quot;死&quot;</span>));</span><br><span class="line">        System.out.println(bloomFilter.mightContain(<span class="string">&quot;磕&quot;</span>));</span><br><span class="line">        System.out.println(bloomFilter.mightContain(<span class="string">&quot;Java&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// console:</span></span><br><span class="line"><span class="literal">true</span></span><br><span class="line"><span class="literal">true</span></span><br><span class="line"><span class="literal">true</span></span><br><span class="line"><span class="literal">false</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> <span class="number">1000000</span>;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> BloomFilter&lt;Integer&gt; bloomFilter =BloomFilter.create(Funnels.integerFunnel(), size);</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;        </span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++) &#123;            </span><br><span class="line">            bloomFilter.put(i);        </span><br><span class="line">        &#125;        </span><br><span class="line">        </span><br><span class="line">        List&lt;Integer&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Integer&gt;(<span class="number">1000</span>);</span><br><span class="line">        <span class="comment">//故意取10000个不在过滤器里的值，看看有多少个会被认为在过滤器里</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> size + <span class="number">10000</span>; i &lt; size + <span class="number">20000</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (bloomFilter.mightContain(i)) &#123;</span><br><span class="line">                list.add(i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;误判的数量：&quot;</span> + list.size());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line"><span class="comment">//设置redis地址</span></span><br><span class="line">config.useSingleServer().setAddress(<span class="string">&quot;redis://127.0.0.1:6379&quot;</span>);</span><br><span class="line"><span class="comment">//构造Redisson</span></span><br><span class="line"><span class="type">RedissonClient</span> <span class="variable">redisson</span> <span class="operator">=</span> Redisson.create(config);</span><br><span class="line">RBloomFilter&lt;String&gt; bloomFilter = redisson.getBloomFilter(<span class="string">&quot;bloom&quot;</span>);</span><br><span class="line"><span class="comment">//初始化布隆过滤器：初始化长度为1000000L,误判率为1%</span></span><br><span class="line">bloomFilter.tryInit(<span class="number">1000000L</span>,<span class="number">0.01</span>);</span><br><span class="line">bloomFilter.add(<span class="string">&quot;1&quot;</span>); </span><br><span class="line"><span class="comment">//增加数据</span></span><br><span class="line"><span class="comment">//判断指定编号是否在布隆过滤器中</span></span><br><span class="line">System.out.println(bloomFilter.contains(<span class="string">&quot;1&quot;</span>)); </span><br><span class="line"><span class="comment">//输出true</span></span><br><span class="line">System.out.println(bloomFilter.contains(<span class="string">&quot;8888&quot;</span>));</span><br><span class="line"><span class="comment">//输出false</span></span><br><span class="line"><span class="comment">//这里设置1%的误判率不算不会对系统产生很大的影响，</span></span><br><span class="line"><span class="comment">//要是碰到缓存穿透攻击，1万个请求到达数据库层面的也就只有100个，这些漏网请求也不会对系统产生实质性影响</span></span><br></pre></td></tr></table></figure>

<h4 id="5、业务场景："><a href="#5、业务场景：" class="headerlink" title="5、业务场景："></a>5、业务场景：</h4><h5 id="5-1-配置类：把布隆过滤器对象注入进IOC容器。"><a href="#5-1-配置类：把布隆过滤器对象注入进IOC容器。" class="headerlink" title="5.1 配置类：把布隆过滤器对象注入进IOC容器。"></a>5.1 配置类：把布隆过滤器对象注入进IOC容器。</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.google.common.hash.BloomFilter;</span><br><span class="line"><span class="keyword">import</span> com.google.common.hash.Funnels;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BloomFilterConfig</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * expectedInsertions：期望添加的数据个数</span></span><br><span class="line"><span class="comment">     * fpp：期望的误判率，期望的误判率越低，布隆过滤器计算时间越长</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> BloomFilter&lt;String&gt; <span class="title function_">goodsIDBloom</span><span class="params">()</span>&#123;</span><br><span class="line">        BloomFilter&lt;String&gt; filter = BloomFilter.create(Funnels.stringFunnel(Charset.forName(<span class="string">&quot;utf-8&quot;</span>)), <span class="number">1000</span>,<span class="number">0.00001</span>);</span><br><span class="line">        <span class="keyword">return</span> filter;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> BloomFilter&lt;String&gt; <span class="title function_">orderBloom</span><span class="params">()</span>&#123;</span><br><span class="line">        BloomFilter&lt;String&gt; filter = BloomFilter.create(Funnels.stringFunnel(Charset.forName(<span class="string">&quot;utf-8&quot;</span>)), <span class="number">1000</span>,<span class="number">0.00001</span>);</span><br><span class="line">        <span class="keyword">return</span> filter;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-2-启动项目时把所有key插入布隆过滤器"><a href="#5-2-启动项目时把所有key插入布隆过滤器" class="headerlink" title="5.2 启动项目时把所有key插入布隆过滤器"></a>5.2 启动项目时把所有key插入布隆过滤器</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;</span><br><span class="line"><span class="keyword">import</span> com.google.common.hash.BloomFilter;</span><br><span class="line"><span class="keyword">import</span> com.liu.seckill.entity.SeckillGood;</span><br><span class="line"><span class="keyword">import</span> com.liu.seckill.service.SeckillGoodService;</span><br><span class="line"><span class="keyword">import</span> com.liu.seckill.service.UserService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.InitializingBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.Scheduled;</span><br><span class="line"><span class="keyword">import</span> java.time.Duration;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InitConfig</span> <span class="keyword">implements</span> <span class="title class_">InitializingBean</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserService userService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    SeckillGoodService seckillGoodService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RedisTemplate redisTemplate;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RedisConfig redisConfig;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(&quot;goodsIDBloom&quot;)</span></span><br><span class="line">    BloomFilter&lt;String&gt; goodsIDBloom;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 把商品库存加载到 Redis中</span></span><br><span class="line"><span class="comment">     * 每天更新</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Scheduled(fixedRate = 1000*60*60*24)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//只缓存秒杀还没结束或秒杀还没开始的商品</span></span><br><span class="line">        List&lt;SeckillGood&gt; seckillGoods = seckillGoodService.list(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;SeckillGood&gt;().ge(<span class="string">&quot;end_time&quot;</span>, LocalDateTime.now()));</span><br><span class="line">        <span class="keyword">if</span> (seckillGoods == <span class="literal">null</span>) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;暂无秒杀商品&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//将秒杀商品ID和库存分别存入redis中</span></span><br><span class="line">        List&lt;Long&gt; seckillGoodIDList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (SeckillGood seckillGood : seckillGoods) &#123;</span><br><span class="line">            seckillGoodIDList.add(seckillGood.getSgId());</span><br><span class="line">            <span class="comment">//设置过期时间</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">millis</span> <span class="operator">=</span> Duration.between(LocalDateTime.now(), seckillGood.getEndTime()).toMillis();</span><br><span class="line">            redisTemplate.opsForValue().set(<span class="string">&quot;seckillGoodID:&quot;</span> + seckillGood.getSgId(), seckillGood.getSgStock(), millis, TimeUnit.MILLISECONDS);</span><br><span class="line">            <span class="comment">//存储值到布隆过滤器中</span></span><br><span class="line">            goodsIDBloom.put(seckillGood.getSgId()+<span class="string">&quot;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;seckillGoodIDList:&quot;</span>, seckillGoodIDList,<span class="number">1</span>,TimeUnit.DAYS);</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-3-使用布隆过滤器"><a href="#5-3-使用布隆过滤器" class="headerlink" title="5.3 使用布隆过滤器"></a>5.3 使用布隆过滤器</h5><p>查询redis之前先走布隆过滤器，如果布隆过滤器判断没有则一定没有。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/seckillOrder&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeckillOrderController</span>  &#123;</span><br><span class="line"> 	<span class="comment">//如果有多个布隆过滤器，就同时使用@Qualifier和@Autowired</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(&quot;goodsIDBloom&quot;)</span></span><br><span class="line">    BloomFilter&lt;String&gt; goodsIDBloom;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(&quot;orderBloom&quot;)</span></span><br><span class="line">    BloomFilter&lt;String&gt; orderBloom;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/seckillGoods/&#123;goodId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">seckillGoods</span><span class="params">(<span class="meta">@PathVariable(&quot;goodId&quot;)</span> Long goodId)</span> &#123;</span><br><span class="line">        <span class="type">ValueOperations</span> <span class="variable">valueOperations</span> <span class="operator">=</span> redisTemplate.opsForValue();</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//判断秒杀商品是否存在</span></span><br><span class="line">        <span class="comment">//如果商品id在布隆过滤器中存在，那么就要再去判断在不在redis中，在，才能证明真的在</span></span><br><span class="line">        <span class="keyword">if</span> (goodsIDBloom.mightContain(goodId+<span class="string">&quot;&quot;</span>))&#123;</span><br><span class="line">            ArrayList&lt;Long&gt; seckillGoodIDList = (ArrayList&lt;Long&gt;) valueOperations.get(<span class="string">&quot;seckillGoodIDList:&quot;</span>);</span><br><span class="line">            Assert.isTrue(seckillGoodIDList.contains(goodId),<span class="string">&quot;未找到该商品，商品ID有误或此商品不参与秒杀或此商品秒杀已结束&quot;</span>);</span><br><span class="line">            <span class="comment">// 此处当seckillGoodIDList.contains(goodId) 为true时不会走后面异常信息。源码如下：</span></span><br><span class="line">            <span class="comment">//  public static void isTrue(boolean expression, String message) &#123;</span></span><br><span class="line">            <span class="comment">//        if (!expression) &#123;</span></span><br><span class="line">            <span class="comment">//            throw new IllegalArgumentException(message);</span></span><br><span class="line">            <span class="comment">//        &#125;</span></span><br><span class="line">            <span class="comment">//  &#125;</span></span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            Assert.isTrue(<span class="literal">false</span>,<span class="string">&quot;未找到该商品，商品ID有误或此商品不参与秒杀或此商品秒杀已结束&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-4-redis伪代码如下所示"><a href="#5-4-redis伪代码如下所示" class="headerlink" title="5.4 redis伪代码如下所示"></a>5.4 redis伪代码如下所示</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">String <span class="title function_">get</span><span class="params">(String key)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> redis.get(key);     </span><br><span class="line">    <span class="keyword">if</span> (value  == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(!bloomfilter.mightContain(key))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>; </span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            value = db.get(key); </span><br><span class="line">            redis.set(key, value); </span><br><span class="line">        &#125;    </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value；</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 优点</p>
<ol>
<li><p>思路简单</p>
</li>
<li><p>保证一致性</p>
</li>
<li><p>性能强</p>
</li>
</ol>
<p> 缺点</p>
<ol>
<li><p>代码复杂度增大</p>
</li>
<li><p>需要另外维护一个集合来存放缓存的Key</p>
</li>
<li><p>布隆过滤器不支持删值操作</p>
</li>
</ol>
<h5 id="6、布隆过滤器在项目中的使用流程"><a href="#6、布隆过滤器在项目中的使用流程" class="headerlink" title="6、布隆过滤器在项目中的使用流程"></a>6、布隆过滤器在项目中的使用流程</h5><p><img src="/images/WEBRESOURCEdf29995c6ee4c6a40404363bf50af4a0.png"></p>
<h5 id="7、数据被删除了怎么办"><a href="#7、数据被删除了怎么办" class="headerlink" title="7、数据被删除了怎么办"></a>7、数据被删除了怎么办</h5><p>布隆过滤器因为某一位二进制可能被多个编号Hash引用，因此布隆过滤器无法直接处理删除数据的情况。</p>
<ul>
<li>解决方案1：定时异步重建布隆过滤器</li>
</ul>
<p>比如每过一个小时，异步的执行一个任务调度，来重新生成布隆过滤器，替换掉已有的布隆过滤器。</p>
<ul>
<li>解决方案2：计数Bloom Fliter</li>
</ul>
<p>在标准的布隆过滤器下是无法得知当前某一位索引，是被那些具体数据引用的。但是计数布隆过滤器，他是在这一位上额外附加了计数信息，表达了该位被几个数据引用。删除数据的同时相应的计数信息减1，就完成了布隆过滤器数据的删除。</p>
<ul>
<li>直接记录hash冲突次数。布隆过滤器增加一个等长的数组，存储计数器，主要解决冲突问题，每次删除时对应的计数器减一，如果结果为0，更新主数组的二进制值为0</li>
</ul>
<p>明显，不论哪种方案，都决定了布隆过滤器大多数情况只能应用在缓存数据更新较慢的情况下</p>
<p>同时，我们布隆过滤器可以添加元素，但是不能删除元素。因为删除元素会导致误判率增加。比如图中，我们将obj1删除，则位置1 3 12都会变为0，但是Obj2共有位置3，这个时候查询obj2时发现位置3的值为0，就会判定不存在obj2，就会造成误判。</p>
<p><img src="/images/WEBRESOURCEe10e35e29ecacae6267584a28dd80aa7.png"></p>
<h1 id="4、缓存预热"><a href="#4、缓存预热" class="headerlink" title="4、缓存预热"></a>4、缓存预热</h1><p>所谓缓存预热就是将一些可能经常使用数据在系统启动的时候预先设置到缓存中，这样可以避免在使用到的时候先去数据库中查询。</p>
<p>这就是缓存预热，名气高大上，实际上很简单有木有，这个缓存预热我在实际场景是经常使用的。</p>
<p>还有一种方式就是添加一个缓存刷新页，这样通过人工干预的方式将一些可能为热点的key添加到缓存中。</p>
<h1 id="5、缓存降级"><a href="#5、缓存降级" class="headerlink" title="5、缓存降级"></a>5、缓存降级</h1><p>当访问量突然剧增（例如下班的点，大家都在地铁上刷手机呢）、服务出现问题（如响应时间慢或不响应）或非核心服务影响到核心流程的性能时，仍然需要保证服务还是可用的，即使是有损服务。</p>
<p>系统可以根据一些关键数据进行自动降级，降级的最终目的是保证核心服务可用，即使是有损的。但是有的一些业务的核心服务是不能降级的。这是一种丢卒保帅的思想。</p>
<p>服务降级的目的，是为了防止 Redis 服务故障，导致数据库跟着一起发生雪崩问题。因此，对于不重要的缓存数据，可以采取服务降级策略，例如一个比较常见的做法就是， Redis出现问题，不去数据库查询，而是直接返回默认值给用户。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="https://issac2e.github.io">issac</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://issac2e.github.io/2023/02/06/Redis/Redis%20%E9%9B%AA%E5%B4%A9%E3%80%81%E5%87%BB%E7%A9%BF%E3%80%81%E7%A9%BF%E9%80%8F%E3%80%81%E9%A2%84%E7%83%AD%E3%80%81%E9%99%8D%E7%BA%A7/">https://issac2e.github.io/2023/02/06/Redis/Redis%20%E9%9B%AA%E5%B4%A9%E3%80%81%E5%87%BB%E7%A9%BF%E3%80%81%E7%A9%BF%E9%80%8F%E3%80%81%E9%A2%84%E7%83%AD%E3%80%81%E9%99%8D%E7%BA%A7/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Redis/">Redis</a><a class="post-meta__tags" href="/tags/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/">布隆过滤器</a></div><div class="post_share"><div class="social-share" data-image="/./img/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/02/11/UofG/Advanced%20Programming/" title="Advanced Programming"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Advanced Programming</div></div></a></div><div class="next-post pull-right"><a href="/2023/01/30/UofG/Internet%20Technology/" title="Internet Technology"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Internet Technology</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/./img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">issac</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">15</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">14</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">8</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/issac2e"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/issac2e" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:issac2e@163.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">哈哈哈哈哈哈哈哈</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1%E3%80%81%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF"><span class="toc-text">1、缓存击穿</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2%E3%80%81%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9"><span class="toc-text">2、缓存雪崩</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3%E3%80%81%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F"><span class="toc-text">3、缓存穿透</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E4%B9%8B%E7%BC%93%E5%AD%98%E7%A9%BA%E6%95%B0%E6%8D%AE"><span class="toc-text">1、缓存穿透解决方案之缓存空数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E4%B9%8B%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-text">2、缓存穿透解决方案之布隆过滤器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8%E8%AF%B4%E6%98%8E%E7%99%BD%EF%BC%81"><span class="toc-text">布隆过滤器说明白！</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E4%B8%A4%E4%B8%AA%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">1、两个使用场景:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E5%8E%9F%E7%90%86"><span class="toc-text">2、原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81%E5%A6%82%E4%BD%95%E5%87%8F%E5%B0%91%E8%AF%AF%E5%88%A4%E7%9A%84%E5%8F%91%E7%94%9F%EF%BC%9A"><span class="toc-text">3、如何减少误判的发生：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%E3%80%81%E5%AE%9E%E7%8E%B0"><span class="toc-text">4、实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5%E3%80%81%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF%EF%BC%9A"><span class="toc-text">5、业务场景：</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1-%E9%85%8D%E7%BD%AE%E7%B1%BB%EF%BC%9A%E6%8A%8A%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8%E5%AF%B9%E8%B1%A1%E6%B3%A8%E5%85%A5%E8%BF%9BIOC%E5%AE%B9%E5%99%A8%E3%80%82"><span class="toc-text">5.1 配置类：把布隆过滤器对象注入进IOC容器。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2-%E5%90%AF%E5%8A%A8%E9%A1%B9%E7%9B%AE%E6%97%B6%E6%8A%8A%E6%89%80%E6%9C%89key%E6%8F%92%E5%85%A5%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-text">5.2 启动项目时把所有key插入布隆过滤器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3-%E4%BD%BF%E7%94%A8%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-text">5.3 使用布隆过滤器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-4-redis%E4%BC%AA%E4%BB%A3%E7%A0%81%E5%A6%82%E4%B8%8B%E6%89%80%E7%A4%BA"><span class="toc-text">5.4 redis伪代码如下所示</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6%E3%80%81%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8%E5%9C%A8%E9%A1%B9%E7%9B%AE%E4%B8%AD%E7%9A%84%E4%BD%BF%E7%94%A8%E6%B5%81%E7%A8%8B"><span class="toc-text">6、布隆过滤器在项目中的使用流程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7%E3%80%81%E6%95%B0%E6%8D%AE%E8%A2%AB%E5%88%A0%E9%99%A4%E4%BA%86%E6%80%8E%E4%B9%88%E5%8A%9E"><span class="toc-text">7、数据被删除了怎么办</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4%E3%80%81%E7%BC%93%E5%AD%98%E9%A2%84%E7%83%AD"><span class="toc-text">4、缓存预热</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5%E3%80%81%E7%BC%93%E5%AD%98%E9%99%8D%E7%BA%A7"><span class="toc-text">5、缓存降级</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/03/17/UofG/itProject_Python/" title="itProject_Python">itProject_Python</a><time datetime="2023-03-17T22:02:08.000Z" title="Created 2023-03-17 22:02:08">2023-03-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/02/24/UofG/cardGame/" title="Card Game流程梳理">Card Game流程梳理</a><time datetime="2023-02-24T22:02:08.000Z" title="Created 2023-02-24 22:02:08">2023-02-24</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/02/14/UofG/Software%20Engineering/" title="Software Engineering">Software Engineering</a><time datetime="2023-02-14T22:02:08.000Z" title="Created 2023-02-14 22:02:08">2023-02-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/02/11/UofG/Advanced%20Programming/" title="Advanced Programming">Advanced Programming</a><time datetime="2023-02-11T22:02:08.000Z" title="Created 2023-02-11 22:02:08">2023-02-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/02/06/Redis/Redis%20%E9%9B%AA%E5%B4%A9%E3%80%81%E5%87%BB%E7%A9%BF%E3%80%81%E7%A9%BF%E9%80%8F%E3%80%81%E9%A2%84%E7%83%AD%E3%80%81%E9%99%8D%E7%BA%A7/" title="Redis 雪崩、击穿、穿透、预热、降级">Redis 雪崩、击穿、穿透、预热、降级</a><time datetime="2023-02-06T22:36:08.000Z" title="Created 2023-02-06 22:36:08">2023-02-06</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By issac</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>